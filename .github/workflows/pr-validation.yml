name: PR Validation – SC2 Bot

on:
  pull_request:
    paths:
      - 'game_check/**'
      - 'weapon_check_bot.py'
      - 'build_sc2map.py'
      - '.github/workflows/pr-validation.yml'

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        map:
          - MagannathaAIE_5_0_14
          - UltraloveAIE_5_0_14
          - LeyLinesAIE_5_0_14
          - TorchesAIE_5_0_14
          - PylonAIE_5_0_14
          - PersephoneAIE_5_0_14
    name: Build & Test ${{ matrix.map }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build SC2 map
        run: |
          mkdir -p Output
          BASE="maps/${{ matrix.map%%_* }}"  # extract "maps/PylonAIE"
          echo "=== Building map: ${{ matrix.map }} (from $BASE) ==="
          python build_sc2map.py "$BASE" mods/Patch_5_0_14 mods/AiArenaExtraFixes "Output/${{ matrix.map }}"
          echo "✅ Map built:"
          ls -lh Output/

      - name: Pull SC2 Docker image
        run: docker pull cpp-sc2/docker-sc2:latest

      - name: Run weapon check bot
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "${{ github.workspace }}/Output:/root/StarCraftII/Maps" \
            cpp-sc2/docker-sc2:latest \
            /bin/bash -c "cd /workspace && python game_check/weapon_check_bot.py --map ${{ matrix.map }}"
