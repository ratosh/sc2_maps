name: PR Validation ‚Äì SC2 Bot

on:
  pull_request:
    paths:
      - "game_check/**"
      - "weapon_check_bot.py"
      - "build_sc2map.py"
      - ".github/workflows/pr-validation.yml"

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        map:
          - PylonAIE_5_0_14
          # - MagannathaAIE_5_0_14
          # - UltraloveAIE_5_0_14
          # - LeyLinesAIE_5_0_14
          # - TorchesAIE_5_0_14
          # - PersephoneAIE_5_0_14
    name: Build & Test ${{ matrix.map }}

    steps:
      - uses: actions/checkout@v4

      - name: üîÑ Build SC2 Map
        id: build_map
        uses: ./.github/actions/build-sc2-map
        with:
          map: ${{ matrix.map }}
      - name: üîç Verify SC2 map file
        run: |
          FILE_PATH="${{ steps.build_map.outputs.output_path }}"
          echo "Output path: $FILE_PATH"
          if [ -f "$FILE_PATH" ]; then
            echo "‚úÖ File exists"
            ls -lh "$FILE_PATH"
          else
            echo "‚ùå File does not exist"
            ls -lh Output/
            exit 1
          fi
        shell: bash

      - name: üì§ Upload built map (for debugging / download)
        uses: actions/upload-artifact@v4
        with:
          name: built-map-${{ matrix.map }}
          path: ${{ steps.build_map.outputs.output_path }}

      - name: üê≥ Pull SC2 Docker image
        run: docker pull aiarena/arenaclient:latest

      - name: üß™ Run weapon check bot
        run: |
          MAP="${{ matrix.map }}"
          MAP_PATH="$(realpath "$(dirname "${{ steps.build_map.outputs.output_path }}")")"
          echo "MAP_PATH $MAP_PATH"
          echo "MAP $MAP"
          CMD="docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "$MAP_PATH:/root/StarCraftII/Maps/" \
            --entrypoint python \
            aiarena/arenaclient:latest \
            /workspace/game_check/weapon_check_bot.py --map "$MAP""
            
          echo "========== DOCKER RUN COMMAND =========="
          echo "$CMD"
          echo "========================================"

          eval $CMD
          RET=$?
          if [ $RET -ne 0 ]; then
            echo "‚ùå Validation failed for $MAP"
            exit 1
          fi
