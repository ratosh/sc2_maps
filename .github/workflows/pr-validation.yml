name: PR Validation ‚Äì SC2 Bot

on:
  pull_request:
    paths:
      - 'game_check/**'
      - 'weapon_check_bot.py'
      - 'build_sc2map.py'
      - '.github/workflows/pr-validation.yml'

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        map:
          - PylonAIE_5_0_14
          # - MagannathaAIE_5_0_14
          # - UltraloveAIE_5_0_14
          # - LeyLinesAIE_5_0_14
          # - TorchesAIE_5_0_14
          # - PersephoneAIE_5_0_14
    name: Build & Test ${{ matrix.map }}

    steps:
      - uses: actions/checkout@v4
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Build SC2 map
        run: |
          mkdir -p Output
          MAP="${{ matrix.map }}"
          BASE="maps/${MAP%%_*}"  # Bash expansion happens here
          echo "=== Building map: $MAP (from $BASE) ==="
          python build_sc2map.py "$BASE" mods/Patch_5_0_14 mods/AiArenaExtraFixes "Output/$MAP"
          echo "‚úÖ Map built:"
          ls -lh Output/
      - name: Pull SC2 Docker image
        run: docker pull stephanzlatarev/starcraft:latest
      - name: Run weapon check bot
        run: |
          MAP="${{ matrix.map }}"
          echo "=== Running validation for $MAP ==="
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "${{ github.workspace }}/Output:/root/StarCraftII/Maps" \
            stephanzlatarev/starcraft:latest \
            /bin/bash -c "
              cd /workspace && \
              python game_check/weapon_check_bot.py --map $MAP; \
              RET=\$?; \
              if [ \$RET -ne 0 ]; then
                echo '‚ùå Validation failed for' $MAP
                exit 1
              fi
            "
